"use strict";function _formatDate(e,t,i){var r=e,n=/\b\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{9}(Z|(\+\d{2}:\d{2}))\b/g,s="",a=r.match(n);return!a||!a.length||a.length<1?lastDate?(r=t?'<font color="#ffc20e">['+lastDate+"]</font> "+r+"\n":"["+lastDate+"] "+r+"\n",void i(null,r)):void i(null,r):void async.each(a,function(e,i){var n=moment(e).format("YYYY-MM-DD HH:mm:ss");lastDate=n,s=new RegExp(e.replace(/\+/g,"\\+"),"g"),r=r.replace(s,"").trim(),""===r?i():(r=t?'<font color="#ffc20e">['+n+"]</font> "+r+"\n":"["+n+"] "+r+"\n",i())},function(t){return t?(e+="\n",void i(t,e)):void i(null,r)})}const moment=require("moment"),async=require("async"),logger=require("../../utils/logger").getLogger("logFormatter"),LogFormatter=function(){this.remainingMessage="",this.buildLogs="",this.lastEscapeLine="",this.regexFilter=[],this.regexFilter.push(/\w+: Pulling image .*/),this.regexFilter.push(/\w+: Pushing .*/),this.regexFilter.push(/\w+: Downloading .*/),this.regexFilter.push(/\w+: Buffering to disk */),this.regexFilter.push(/\w+: Extracting */),this.regexFilter.push(/.*Sending build context to Docker daemon .*/)};LogFormatter.prototype.formatLog=function(e,t){if(process.env.DISABLE_LOG_FORMAT)return e.toString();if(this.buildLogs="",null!=e&&e.length>0){for(var i=this.remainingMessage+e.toString();-1!=i.indexOf("\r");)i=i.replace("\r","\n");var r=i.split("\n"),n="\n"==i.match("\\n$");n?this.remainingMessage="":(this.remainingMessage=r[r.length-1],r.splice(r.length-1,1));var s=this;r.forEach(function(e){var i=!1;if(i=e.indexOf("\\033")>=0||0==e.indexOf("\\034")||0==e.indexOf("["))s.lastEscapeLine=e;else{var r=s.lastEscapeLine.trim();""!=r&&(r=r.replace(/\033/g,""),r=r.replace(/\034/g,""),r=r.replace(/\[[0-9]{1,2}[A-Z]{1}/g,""),r=r.trim(),""!=r&&_formatDate(r,t,function(e,t){t&&(s.buildLogs+=t)}),s.lastEscapeLine="")}i||""==e.trim()||_formatDate(e,t,function(e,t){t&&(s.buildLogs+=t)})})}return this.buildLogs};var lastDate;module.exports=LogFormatter;